{
  "$schema": "https://www.krakend.io/schema/v3.json",
  "version": 3,
  "name": "My first API Gateway - KrakenD",
  "port": 8080,
  "host": ["http://fakeapi:8088"],
  "echo_endpoint": true,
  "debug_endpoint": true,
  "endpoints": [
    {
      "endpoint": "/home_dashboard",
      "input_headers": ["*"],
      "input_query_strings": [
          "customer",
          "profile"
      ],
      "backend": [
        { 
            "url_pattern": "/__workflow/customized_dashboard/{req_querystring.profile}",
            "group": "custom_content",
            "extra_config": {
                "workflow": {
                    "endpoint": "/__workflow_impl/customized_dashboard/{req_querystring.profile}",
                    "ignore_errors": true,
                    "extra_config": {
                        "proxy": { "sequential": true} 
                    },
                    "backend": [
                        {
                            "url_pattern": "/default_profile",
                            "extra_config": {
                                "validation/cel": [
                                    {
                                        "check_expr": "('profile' in req_querystring) == false || size(req_querystring.profile) == 0 || size(req_querystring.profile[0]) == 0"
                                    }
                                ]
                            }
                        },
                        {
                            "url_pattern": "/__workflow/for_profile_content/?q={resp0_profile.profile_id}",
                            "group": "recommended",
                            "extra_config": {
                                "workflow": {
                                    "endpoint": "/__workflow_impl/for_profile_content",
                                    "backend": [
                                        {
                                            "url_pattern": "/profile_recommended_movies"
                                        },
                                        {
                                            "url_pattern": "/profile_recommended_actors"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        }
      ]
    }
  ]
}
